# é”™è¯¯å¤„ç†ä¸å¼‚å¸¸ç®¡ç†æŒ‡å—

## ğŸ“– æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†ECommerceå¹³å°ä¸­çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼ŒåŒ…æ‹¬éªŒè¯é”™è¯¯ã€ä¸šåŠ¡å¼‚å¸¸å’Œç³»ç»Ÿå¼‚å¸¸çš„å¤„ç†æ–¹å¼ï¼Œä»¥åŠå¦‚ä½•å°†è¿™äº›é”™è¯¯ä¿¡æ¯æ­£ç¡®è¿”å›ç»™å‰ç«¯ã€‚

## ğŸš¨ é”™è¯¯å¤„ç†æ¶æ„

### é‡è¦è¯´æ˜ï¼šValidationExceptionçš„æ­£ç¡®ä½¿ç”¨

**âš ï¸ å¸¸è§é—®é¢˜ï¼š** å¦‚æœ`message`ä¸ºç©ºï¼Œé€šå¸¸æ˜¯å› ä¸º`ValidationException`æ²¡æœ‰æ­£ç¡®åŒ…å«`Errors`é›†åˆã€‚

**é”™è¯¯ç¤ºä¾‹ï¼š**
```csharp
// âŒ é”™è¯¯ï¼šåªä¼ é€’æ¶ˆæ¯å­—ç¬¦ä¸²ï¼Œæ²¡æœ‰Errorsé›†åˆ
throw new ValidationException("éªŒè¯å¤±è´¥");
```

**æ­£ç¡®ç¤ºä¾‹ï¼š**
```csharp
// âœ… æ­£ç¡®ï¼šä¼ é€’ValidationFailureé›†åˆ
throw new ValidationException(failures);
```

### å…¨å±€å¼‚å¸¸å¤„ç†ä¸­é—´ä»¶

æˆ‘ä»¬ä½¿ç”¨`GlobalExceptionMiddleware`æ¥ç»Ÿä¸€å¤„ç†æ‰€æœ‰å¼‚å¸¸ï¼Œç¡®ä¿é”™è¯¯ä¿¡æ¯èƒ½å¤Ÿæ­£ç¡®è¿”å›ç»™å‰ç«¯ï¼š

```csharp
public class GlobalExceptionMiddleware
{
    public async Task InvokeAsync(HttpContext context)
    {
        try
        {
            await next(context);
        }
        catch (ValidationException ex)
        {
            // å¤„ç†FluentValidationéªŒè¯å¼‚å¸¸
            var errorMessages = ex.Errors.Select(e => e.ErrorMessage).ToList();
            var combinedMessage = string.Join("; ", errorMessages);
            
            await WriteResponse(context, HttpStatusCode.BadRequest, 
                ApiResponse<string>.Fail("VALIDATION_ERROR", combinedMessage));
        }
        catch (UnauthorizedAccessException ex)
        {
            // å¤„ç†è®¤è¯å¼‚å¸¸
            await WriteResponse(context, HttpStatusCode.Unauthorized, 
                ApiResponse<string>.Fail("UNAUTHORIZED", ex.Message));
        }
        catch (ArgumentException ex)
        {
            // å¤„ç†å‚æ•°å¼‚å¸¸
            await WriteResponse(context, HttpStatusCode.BadRequest, 
                ApiResponse<string>.Fail("BAD_REQUEST", ex.Message));
        }
        catch (InvalidOperationException ex)
        {
            // å¤„ç†ä¸šåŠ¡é€»è¾‘å¼‚å¸¸
            await WriteResponse(context, HttpStatusCode.BadRequest, 
                ApiResponse<string>.Fail("BUSINESS_ERROR", ex.Message));
        }
        catch (Exception ex)
        {
            // å¤„ç†æœªé¢„æœŸçš„ç³»ç»Ÿå¼‚å¸¸
            await WriteResponse(context, HttpStatusCode.InternalServerError, 
                ApiResponse<string>.Fail("INTERNAL_ERROR", "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯"));
        }
    }
}
```

## â±ï¸ è¶…æ—¶å¤„ç†ä¸æ€§èƒ½ä¼˜åŒ–

### 1. ç½‘å…³è¶…æ—¶é…ç½®

ä¸ºäº†é˜²æ­¢è¯·æ±‚é•¿æ—¶é—´æŒ‚èµ·ï¼Œæˆ‘ä»¬åœ¨ç½‘å…³é…ç½®ä¸­è®¾ç½®äº†åˆç†çš„è¶…æ—¶æ—¶é—´ï¼š

```json
{
  "ReverseProxy": {
    "Clusters": {
      "identity": {
        "Destinations": {
          "d1": {
            "Address": "http://localhost:5101/"
          }
        },
        "HttpRequest": {
          "Timeout": "00:00:30"  // 30ç§’è¶…æ—¶
        }
      }
    }
  }
}
```

### 2. Redisæ“ä½œè¶…æ—¶æ§åˆ¶

ä¸ºRedisæ“ä½œæ·»åŠ è¶…æ—¶æ§åˆ¶ï¼Œé˜²æ­¢è¿æ¥é—®é¢˜å¯¼è‡´æœåŠ¡æŒ‚èµ·ï¼š

```csharp
public class RedisHelper : IRedisHelper
{
    private readonly IDatabase database;
    private readonly TimeSpan defaultTimeout = TimeSpan.FromSeconds(10);

    public async Task<T?> GetAsync<T>(string key)
    {
        using var cts = new CancellationTokenSource(defaultTimeout);
        var json = await database.StringGetAsync(key);
        if (json.IsNullOrEmpty)
        {
            return default;
        }
        return JsonSerializer.Deserialize<T>(json!);
    }
}
```

### 3. éªŒè¯ç æœåŠ¡è¶…æ—¶å¤„ç†

ä¸ºéªŒè¯ç æœåŠ¡æ·»åŠ å®Œæ•´çš„è¶…æ—¶å’Œé”™è¯¯å¤„ç†ï¼š

```csharp
public class EmailVerificationService : IVerificationCodeService
{
    private readonly TimeSpan operationTimeout = TimeSpan.FromSeconds(10);

    public async Task<bool> VerifyCodeAsync(string email, string code)
    {
        try
        {
            using var cts = new CancellationTokenSource(operationTimeout);
            var key = GetRedisKey(email);
            var cachedCode = await redisHelper.GetAsync<string>(key);

            if (cachedCode == null || cachedCode != code)
            {
                logger.LogWarning("éªŒè¯ç éªŒè¯å¤±è´¥: {Email}, è¾“å…¥ç : {InputCode}, ç¼“å­˜ç : {CachedCode}", 
                    email, code, cachedCode ?? "null");
                return false;
            }

            await redisHelper.DeleteAsync(key);
            logger.LogInformation("éªŒè¯ç éªŒè¯æˆåŠŸ: {Email}", email);
            return true;
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "éªŒè¯ç éªŒè¯è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: {Email}", email);
            throw new InvalidOperationException("éªŒè¯ç éªŒè¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
        }
    }
}
```

### 4. æ•°æ®åº“è¿æ¥è¶…æ—¶è®¾ç½®

ä¸ºæ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²æ·»åŠ è¶…æ—¶é…ç½®ï¼š

```json
{
  "ConnectionStrings": {
    "UserDb": "Server=localhost;Database=ECommerceIdentity;User Id=sa;Password=***;TrustServerCertificate=True;Connection Timeout=30;Command Timeout=30;",
    "Redis": "localhost:6379,connectTimeout=10000,syncTimeout=10000"
  }
}
```

### 5. å¸¸è§è¶…æ—¶é—®é¢˜æ’æŸ¥

#### é—®é¢˜ç°è±¡
- è¯·æ±‚é•¿æ—¶é—´æ— å“åº”
- ç½‘å…³æ—¥å¿—æ˜¾ç¤º `RequestTimedOut`
- å®¢æˆ·ç«¯æ”¶åˆ° `TaskCanceledException`

#### æ’æŸ¥æ­¥éª¤
1. **æ£€æŸ¥ä¾èµ–æœåŠ¡çŠ¶æ€**ï¼š
   ```powershell
   netstat -an | findstr "5101\|6379\|1433"
   ```

2. **æ£€æŸ¥æœåŠ¡æ—¥å¿—**ï¼š
   - æŸ¥çœ‹IdentityæœåŠ¡æ—¥å¿—
   - æŸ¥çœ‹Redisè¿æ¥æ—¥å¿—
   - æŸ¥çœ‹æ•°æ®åº“è¿æ¥æ—¥å¿—

3. **éªŒè¯è¶…æ—¶é…ç½®**ï¼š
   - ç¡®è®¤ç½‘å…³è¶…æ—¶è®¾ç½®
   - ç¡®è®¤Redisè¿æ¥å­—ç¬¦ä¸²
   - ç¡®è®¤æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²

#### è§£å†³æ–¹æ¡ˆ
1. **å¯åŠ¨ä¾èµ–æœåŠ¡**ï¼š
   ```powershell
   # å¯åŠ¨Redis
   docker run -d -p 6379:6379 redis:latest
   
   # å¯åŠ¨SQL Server
   docker run -d -p 1433:1433 -e "SA_PASSWORD=***" mcr.microsoft.com/mssql/server:2019-latest
   ```

2. **é‡å¯å¾®æœåŠ¡**ï¼š
   ```powershell
   # é‡å¯IdentityæœåŠ¡
   cd services/identity/ECommerce.Identity.API
   dotnet run
   
   # é‡å¯ç½‘å…³
   cd gateway/ECommerce.APIGateway
   dotnet run
   ```

## ğŸ” é”™è¯¯ç±»å‹ä¸å¤„ç†

### 1. éªŒè¯é”™è¯¯ (ValidationException)

**è§¦å‘åœºæ™¯ï¼š** FluentValidationéªŒè¯å¤±è´¥æ—¶

**é”™è¯¯æ¥æºï¼š**
- ç”¨æˆ·è¾“å…¥æ•°æ®ä¸ç¬¦åˆéªŒè¯è§„åˆ™
- ä¸šåŠ¡è§„åˆ™éªŒè¯å¤±è´¥

**ç¤ºä¾‹ï¼š**
```csharp
// éªŒè¯å™¨å®šä¹‰
public class UpdateUserProfileCommandValidator : AbstractValidator<UpdateUserProfileCommand>
{
    public UpdateUserProfileCommandValidator()
    {
        RuleFor(x => x.Gender)
            .InclusiveBetween(0, 2)
            .WithMessage("æ€§åˆ«åªèƒ½æ˜¯ 0ï¼ˆç”·ï¼‰ã€1ï¼ˆå¥³ï¼‰æˆ– 2ï¼ˆæœªçŸ¥ï¼‰");
            
        RuleFor(x => x.Email)
            .EmailAddress()
            .When(x => !string.IsNullOrWhiteSpace(x.Email))
            .WithMessage("é‚®ç®±æ ¼å¼ä¸æ­£ç¡®");
    }
}
```

**å‰ç«¯æ”¶åˆ°çš„é”™è¯¯å“åº”ï¼š**
```json
{
  "success": false,
  "code": "VALIDATION_ERROR",
  "message": "æ€§åˆ«åªèƒ½æ˜¯ 0ï¼ˆç”·ï¼‰ã€1ï¼ˆå¥³ï¼‰æˆ– 2ï¼ˆæœªçŸ¥ï¼‰; é‚®ç®±æ ¼å¼ä¸æ­£ç¡®",
  "data": null
}
```

### 2. è®¤è¯é”™è¯¯ (UnauthorizedAccessException)

**è§¦å‘åœºæ™¯ï¼š** ç”¨æˆ·æœªç™»å½•æˆ–æƒé™ä¸è¶³

**é”™è¯¯æ¥æºï¼š**
- ç”¨æˆ·æœªæä¾›æœ‰æ•ˆçš„JWT Token
- Tokenå·²è¿‡æœŸ
- ç”¨æˆ·æƒé™ä¸è¶³

**ç¤ºä¾‹ï¼š**
```csharp
// åœ¨Controllerä¸­æŠ›å‡ºè®¤è¯å¼‚å¸¸
private Guid GetCurrentUserId()
{
    var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier);
    return userIdClaim != null ? Guid.Parse(userIdClaim.Value) : 
        throw new UnauthorizedAccessException("ç”¨æˆ·æœªè®¤è¯");
}
```

**å‰ç«¯æ”¶åˆ°çš„é”™è¯¯å“åº”ï¼š**
```json
{
  "success": false,
  "code": "UNAUTHORIZED",
  "message": "ç”¨æˆ·æœªè®¤è¯",
  "data": null
}
```

### 3. ä¸šåŠ¡é€»è¾‘é”™è¯¯ (InvalidOperationException)

**è§¦å‘åœºæ™¯ï¼š** ä¸šåŠ¡è§„åˆ™éªŒè¯å¤±è´¥

**é”™è¯¯æ¥æºï¼š**
- é‚®ç®±å·²å­˜åœ¨
- ç”¨æˆ·çŠ¶æ€ä¸å…è®¸æ“ä½œ
- ä¸šåŠ¡çº¦æŸæ¡ä»¶ä¸æ»¡è¶³

**ç¤ºä¾‹ï¼š**
```csharp
// åœ¨Serviceä¸­æŠ›å‡ºä¸šåŠ¡å¼‚å¸¸
public async Task<Guid> RegisterAsync(RegisterUserCommand command)
{
    if (await userRepository.ExistsByEmailAsync(command.Email))
        throw new InvalidOperationException("é‚®ç®±å·²å­˜åœ¨");
        
    // ... å…¶ä»–ä¸šåŠ¡é€»è¾‘
}
```

**å‰ç«¯æ”¶åˆ°çš„é”™è¯¯å“åº”ï¼š**
```json
{
  "success": false,
  "code": "BUSINESS_ERROR",
  "message": "é‚®ç®±å·²å­˜åœ¨",
  "data": null
}
```

### 4. å‚æ•°é”™è¯¯ (ArgumentException)

**è§¦å‘åœºæ™¯ï¼š** æ–¹æ³•å‚æ•°æ— æ•ˆ

**é”™è¯¯æ¥æºï¼š**
- å¿…éœ€å‚æ•°ä¸ºç©º
- å‚æ•°æ ¼å¼ä¸æ­£ç¡®
- å‚æ•°å€¼è¶…å‡ºèŒƒå›´

**ç¤ºä¾‹ï¼š**
```csharp
public void UpdateUser(Guid userId, string userName)
{
    if (userId == Guid.Empty)
        throw new ArgumentException("ç”¨æˆ·IDä¸èƒ½ä¸ºç©º", nameof(userId));
        
    if (string.IsNullOrWhiteSpace(userName))
        throw new ArgumentException("ç”¨æˆ·åä¸èƒ½ä¸ºç©º", nameof(userName));
}
```

**å‰ç«¯æ”¶åˆ°çš„é”™è¯¯å“åº”ï¼š**
```json
{
  "success": false,
  "code": "BAD_REQUEST",
  "message": "ç”¨æˆ·IDä¸èƒ½ä¸ºç©º",
  "data": null
}
```

### 5. ç³»ç»Ÿé”™è¯¯ (Exception)

**è§¦å‘åœºæ™¯ï¼š** æœªé¢„æœŸçš„ç³»ç»Ÿå¼‚å¸¸

**é”™è¯¯æ¥æºï¼š**
- æ•°æ®åº“è¿æ¥å¤±è´¥
- å¤–éƒ¨æœåŠ¡è°ƒç”¨å¤±è´¥
- ç³»ç»Ÿå†…éƒ¨é”™è¯¯

**å‰ç«¯æ”¶åˆ°çš„é”™è¯¯å“åº”ï¼š**
```json
{
  "success": false,
  "code": "INTERNAL_ERROR",
  "message": "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯",
  "data": null
}
```

## ğŸ“‹ é”™è¯¯å“åº”æ ¼å¼

### ç»Ÿä¸€çš„é”™è¯¯å“åº”ç»“æ„

æ‰€æœ‰é”™è¯¯éƒ½ä½¿ç”¨ç»Ÿä¸€çš„`ApiResponse<T>`æ ¼å¼ï¼š

```csharp
public class ApiResponse<T>
{
    public bool Success { get; set; }
    public string Code { get; set; }
    public string Message { get; set; }
    public T? Data { get; set; }
    
    public static ApiResponse<T> Fail(string code, string message)
    {
        return new ApiResponse<T>
        {
            Success = false,
            Code = code,
            Message = message,
            Data = default
        };
    }
}
```

### HTTPçŠ¶æ€ç æ˜ å°„

| å¼‚å¸¸ç±»å‹ | HTTPçŠ¶æ€ç  | é”™è¯¯ä»£ç  | è¯´æ˜ |
|---------|-----------|---------|------|
| ValidationException | 400 | VALIDATION_ERROR | æ•°æ®éªŒè¯å¤±è´¥ |
| UnauthorizedAccessException | 401 | UNAUTHORIZED | è®¤è¯å¤±è´¥ |
| ArgumentException | 400 | BAD_REQUEST | å‚æ•°é”™è¯¯ |
| InvalidOperationException | 400 | BUSINESS_ERROR | ä¸šåŠ¡é€»è¾‘é”™è¯¯ |
| Exception | 500 | INTERNAL_ERROR | ç³»ç»Ÿå†…éƒ¨é”™è¯¯ |

## ğŸ”§ æœ€ä½³å®è·µ

### 1. Controllerå±‚é”™è¯¯å¤„ç†

**âœ… æ¨èåšæ³•ï¼š** è®©å¼‚å¸¸è‡ªç„¶æŠ›å‡ºï¼Œç”±ä¸­é—´ä»¶ç»Ÿä¸€å¤„ç†

```csharp
[HttpPut("profile")]
public async Task<ActionResult<ApiResponse<string>>> UpdateProfileAsync([FromBody] UpdateUserProfileCommand command)
{
    // ç›´æ¥è°ƒç”¨ï¼Œè®©ValidationBehaviorå¤„ç†éªŒè¯
    await mediator.Send(command);
    return Ok(ApiResponse<string>.Ok("OK", "æ›´æ–°æˆåŠŸ"));
}
```

**âŒ ä¸æ¨èåšæ³•ï¼š** åœ¨Controllerä¸­é‡å¤å¤„ç†å¼‚å¸¸

```csharp
[HttpPut("profile")]
public async Task<ActionResult<ApiResponse<string>>> UpdateProfileAsync([FromBody] UpdateUserProfileCommand command)
{
    try
    {
        await mediator.Send(command);
        return Ok(ApiResponse<string>.Ok("OK", "æ›´æ–°æˆåŠŸ"));
    }
    catch (ValidationException ex) // é‡å¤å¤„ç†ï¼Œä¸æ¨è
    {
        return BadRequest(ApiResponse<string>.Fail("VALIDATION_ERROR", ex.Message));
    }
}
```

### 2. Serviceå±‚é”™è¯¯å¤„ç†

**âœ… æ¨èåšæ³•ï¼š** æŠ›å‡ºå…·ä½“çš„ä¸šåŠ¡å¼‚å¸¸

```csharp
public async Task<Guid> RegisterAsync(RegisterUserCommand command)
{
    // ä¸šåŠ¡éªŒè¯
    if (await userRepository.ExistsByEmailAsync(command.Email))
        throw new InvalidOperationException("é‚®ç®±å·²å­˜åœ¨");
        
    if (await userRepository.ExistsByUserNameAsync(command.UserName))
        throw new InvalidOperationException("ç”¨æˆ·åå·²å­˜åœ¨");
        
    // ä¸šåŠ¡é€»è¾‘...
}
```

### 3. éªŒè¯å™¨é”™è¯¯ä¿¡æ¯

**âœ… æ¨èåšæ³•ï¼š** æä¾›æ¸…æ™°çš„ä¸­æ–‡é”™è¯¯ä¿¡æ¯

```csharp
public class UpdateUserProfileCommandValidator : AbstractValidator<UpdateUserProfileCommand>
{
    public UpdateUserProfileCommandValidator()
    {
        RuleFor(x => x.Gender)
            .InclusiveBetween(0, 2)
            .WithMessage("æ€§åˆ«åªèƒ½æ˜¯ 0ï¼ˆç”·ï¼‰ã€1ï¼ˆå¥³ï¼‰æˆ– 2ï¼ˆæœªçŸ¥ï¼‰");
            
        RuleFor(x => x.Email)
            .EmailAddress()
            .When(x => !string.IsNullOrWhiteSpace(x.Email))
            .WithMessage("é‚®ç®±æ ¼å¼ä¸æ­£ç¡®");
            
        RuleFor(x => x.Phone)
            .Matches(@"^1[3-9]\d{9}$")
            .When(x => !string.IsNullOrWhiteSpace(x.Phone))
            .WithMessage("æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®");
    }
}
```

## ğŸ”§ æ•…éšœæ’é™¤

### é—®é¢˜ï¼šmessageä¸ºç©º

**ç—‡çŠ¶ï¼š**
```json
{
  "success": false,
  "code": "VALIDATION_ERROR",
  "message": "",
  "data": null
}
```

**åŸå› ï¼š** `ValidationException`æ²¡æœ‰æ­£ç¡®åŒ…å«`Errors`é›†åˆ

**è§£å†³æ–¹æ¡ˆï¼š**
1. ç¡®ä¿`ValidationBehavior`ä¸­æŠ›å‡ºå¼‚å¸¸æ—¶ä¼ é€’`failures`é›†åˆï¼š
   ```csharp
   throw new ValidationException(failures);  // âœ… æ­£ç¡®
   ```
   
2. ä¸è¦åªä¼ é€’æ¶ˆæ¯å­—ç¬¦ä¸²ï¼š
   ```csharp
   throw new ValidationException("éªŒè¯å¤±è´¥");  // âŒ é”™è¯¯
   ```

### é—®é¢˜ï¼šéªŒè¯å™¨æ²¡æœ‰æ‰§è¡Œ

**ç—‡çŠ¶ï¼š** å³ä½¿è¾“å…¥æ— æ•ˆæ•°æ®ï¼Œä¹Ÿæ²¡æœ‰æ”¶åˆ°éªŒè¯é”™è¯¯

**åŸå› ï¼š** éªŒè¯å™¨æ²¡æœ‰æ­£ç¡®æ³¨å†Œæˆ–Commandæ²¡æœ‰å®ç°`IRequest`

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ£€æŸ¥Commandæ˜¯å¦å®ç°äº†`IRequest`æˆ–`IRequest<TResponse>`
2. æ£€æŸ¥éªŒè¯å™¨æ˜¯å¦æ­£ç¡®æ³¨å†Œï¼ˆä½¿ç”¨ç¨‹åºé›†æ³¨å†Œï¼‰
3. æ£€æŸ¥Controlleræ˜¯å¦ä½¿ç”¨`mediator.Send()`è°ƒç”¨

## ğŸ§ª æµ‹è¯•é”™è¯¯å¤„ç†

### 1. æµ‹è¯•éªŒè¯é”™è¯¯

```bash
# å‘é€åŒ…å«æ— æ•ˆæ•°æ®çš„è¯·æ±‚
curl -X PUT "http://localhost:5000/api/user/profile" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "email": "invalid-email",
    "gender": -1,
    "phone": "123456789"
  }'
```

**é¢„æœŸå“åº”ï¼š**
```json
{
  "success": false,
  "code": "VALIDATION_ERROR",
  "message": "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®; æ€§åˆ«åªèƒ½æ˜¯ 0ï¼ˆç”·ï¼‰ã€1ï¼ˆå¥³ï¼‰æˆ– 2ï¼ˆæœªçŸ¥ï¼‰; æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®",
  "data": null
}
```

### 2. æµ‹è¯•è®¤è¯é”™è¯¯

```bash
# ä¸æä¾›Tokenæˆ–ä½¿ç”¨æ— æ•ˆToken
curl -X GET "http://localhost:5000/api/user/profile"
```

**é¢„æœŸå“åº”ï¼š**
```json
{
  "success": false,
  "code": "UNAUTHORIZED",
  "message": "ç”¨æˆ·æœªè®¤è¯",
  "data": null
}
```

### 3. æµ‹è¯•ä¸šåŠ¡é”™è¯¯

```bash
# å°è¯•æ³¨å†Œå·²å­˜åœ¨çš„é‚®ç®±
curl -X POST "http://localhost:5000/api/auth/register" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "existing@example.com",
    "password": "Password123",
    "confirmPassword": "Password123"
  }'
```

**é¢„æœŸå“åº”ï¼š**
```json
{
  "success": false,
  "code": "BUSINESS_ERROR",
  "message": "é‚®ç®±å·²å­˜åœ¨",
  "data": null
}
```

## ğŸ“š å‰ç«¯é›†æˆ

### 1. é”™è¯¯å¤„ç†ç¤ºä¾‹

```javascript
// å‰ç«¯é”™è¯¯å¤„ç†ç¤ºä¾‹
async function updateUserProfile(profileData) {
  try {
    const response = await fetch('/api/user/profile', {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(profileData)
    });
    
    const result = await response.json();
    
    if (!result.success) {
      // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
      showError(result.message);
      return;
    }
    
    // å¤„ç†æˆåŠŸå“åº”
    showSuccess(result.message);
  } catch (error) {
    console.error('è¯·æ±‚å¤±è´¥:', error);
    showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
  }
}
```

### 2. é”™è¯¯ä¿¡æ¯æ˜¾ç¤º

```javascript
function showError(message) {
  // å°†é”™è¯¯ä¿¡æ¯æ˜¾ç¤ºç»™ç”¨æˆ·
  // å¯ä»¥æ˜¯toastã€alertæˆ–å…¶ä»–UIç»„ä»¶
  console.error('é”™è¯¯:', message);
  
  // ç¤ºä¾‹ï¼šä½¿ç”¨toastæ˜¾ç¤ºé”™è¯¯
  toast.error(message);
}

function showSuccess(message) {
  // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
  toast.success(message);
}
```

## ğŸ¯ æ€»ç»“

### é”™è¯¯å¤„ç†æµç¨‹

1. **è¯·æ±‚è¿›å…¥** â†’ Controlleræ¥æ”¶è¯·æ±‚
2. **éªŒè¯é˜¶æ®µ** â†’ ValidationBehavioræ‰§è¡ŒFluentValidationéªŒè¯
3. **ä¸šåŠ¡å¤„ç†** â†’ Handleræ‰§è¡Œä¸šåŠ¡é€»è¾‘
4. **å¼‚å¸¸æ•è·** â†’ GlobalExceptionMiddlewareæ•è·æ‰€æœ‰å¼‚å¸¸
5. **é”™è¯¯å“åº”** â†’ ç»Ÿä¸€æ ¼å¼è¿”å›é”™è¯¯ä¿¡æ¯ç»™å‰ç«¯

### å…³é”®ä¼˜åŠ¿

- **ç»Ÿä¸€å¤„ç†**ï¼šæ‰€æœ‰å¼‚å¸¸éƒ½åœ¨ä¸­é—´ä»¶ä¸­ç»Ÿä¸€å¤„ç†
- **æ¸…æ™°æ ¼å¼**ï¼šä½¿ç”¨ç»Ÿä¸€çš„ApiResponseæ ¼å¼
- **ä¸­æ–‡å‹å¥½**ï¼šé”™è¯¯ä¿¡æ¯ä½¿ç”¨ä¸­æ–‡ï¼Œä¾¿äºç”¨æˆ·ç†è§£
- **ç±»å‹å®‰å…¨**ï¼šä¸åŒç±»å‹çš„å¼‚å¸¸æœ‰ä¸åŒçš„é”™è¯¯ä»£ç 
- **æ˜“äºè°ƒè¯•**ï¼šè¯¦ç»†çš„æ—¥å¿—è®°å½•ä¾¿äºé—®é¢˜æ’æŸ¥

### é”™è¯¯ä¿¡æ¯ä¼ é€’è·¯å¾„

```
FluentValidation â†’ ValidationBehavior â†’ GlobalExceptionMiddleware â†’ å‰ç«¯
ä¸šåŠ¡é€»è¾‘å¼‚å¸¸ â†’ Handler â†’ GlobalExceptionMiddleware â†’ å‰ç«¯
ç³»ç»Ÿå¼‚å¸¸ â†’ ä»»æ„ä½ç½® â†’ GlobalExceptionMiddleware â†’ å‰ç«¯
```

é€šè¿‡è¿™ç§è®¾è®¡ï¼Œæ‰€æœ‰çš„é”™è¯¯ä¿¡æ¯éƒ½èƒ½æ­£ç¡®ä¼ é€’åˆ°å‰ç«¯ï¼Œä¸ºç”¨æˆ·æä¾›æ¸…æ™°çš„åé¦ˆï¼

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [MediatRä¸FluentValidationé›†æˆ](06_MediatRä¸FluentValidationé›†æˆ.md) - äº†è§£éªŒè¯æœºåˆ¶
- [BuildingBlocksé€šç”¨ç»„ä»¶åº“](02_BuildingBlocks.md) - äº†è§£ä¸­é—´ä»¶å®ç°
- [Identityèº«ä»½è®¤è¯æœåŠ¡](05_IdentityService.md) - å®Œæ•´çš„æœåŠ¡å®ç°
