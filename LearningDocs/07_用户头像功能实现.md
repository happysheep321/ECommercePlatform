# 07_ç”¨æˆ·å¤´åƒåŠŸèƒ½å®ç° - æœ¬åœ°å¼€å‘ç¯å¢ƒè§£å†³æ–¹æ¡ˆ

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

æœ¬æ–‡æ¡£ä»‹ç»å¦‚ä½•åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒä¸­å®ç°ç”¨æˆ·å¤´åƒåŠŸèƒ½ï¼Œæ— éœ€å¤æ‚çš„æœåŠ¡å™¨é…ç½®ï¼Œç®€å•æ˜“ç”¨ã€‚

## ğŸ“‹ å®ç°æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šæœ¬åœ°æ–‡ä»¶å­˜å‚¨ï¼ˆæ¨èï¼‰

**ä¼˜ç‚¹ï¼š**
- âœ… ç®€å•ç›´æ¥ï¼Œæ— éœ€é¢å¤–æœåŠ¡
- âœ… é€‚åˆæœ¬åœ°å¼€å‘å’Œæµ‹è¯•
- âœ… æ–‡ä»¶ç›´æ¥å­˜å‚¨åœ¨é¡¹ç›®ç›®å½•ä¸­
- âœ… æ”¯æŒé™æ€æ–‡ä»¶è®¿é—®

**ç¼ºç‚¹ï¼š**
- âŒ ä¸é€‚åˆç”Ÿäº§ç¯å¢ƒ
- âŒ æ–‡ä»¶å­˜å‚¨åˆ†æ•£
- âŒ æ‰©å±•æ€§æœ‰é™

## ğŸ—ï¸ æŠ€æœ¯å®ç°

### 1. æ–‡ä»¶ç»“æ„

```
ECommerce.Identity.API/
â”œâ”€â”€ wwwroot/
â”‚   â”œâ”€â”€ images/
â”‚   â”‚   â””â”€â”€ default-avatar.png    # é»˜è®¤å¤´åƒ
â”‚   â””â”€â”€ uploads/
â”‚       â””â”€â”€ avatars/              # ç”¨æˆ·å¤´åƒå­˜å‚¨ç›®å½•
â”œâ”€â”€ Application/
â”‚   â”œâ”€â”€ Services/
â”‚   â”‚   â””â”€â”€ AvatarService.cs      # å¤´åƒæœåŠ¡
â”‚   â””â”€â”€ Validators/
â”‚       â””â”€â”€ AvatarUploadValidator.cs  # ä¸Šä¼ éªŒè¯å™¨
â””â”€â”€ Controllers/
    â””â”€â”€ UserController.cs         # ç”¨æˆ·æ§åˆ¶å™¨
```

### 2. æ ¸å¿ƒæœåŠ¡

#### AvatarService.cs
```csharp
public interface IAvatarService
{
    Task<string> UploadAvatarAsync(IFormFile file, Guid userId);
    Task<byte[]?> GetAvatarAsync(string avatarUrl);
    Task<byte[]?> GetDefaultAvatarAsync();
    Task DeleteAvatarAsync(string avatarUrl);
}
```

**ä¸»è¦åŠŸèƒ½ï¼š**
- æ–‡ä»¶ä¸Šä¼ å’Œå­˜å‚¨
- æ–‡ä»¶è¯»å–å’Œè¿”å›
- æ—§æ–‡ä»¶æ¸…ç†
- é»˜è®¤å¤´åƒå¤„ç†

### 3. APIæ¥å£

#### ä¸Šä¼ å¤´åƒ
```http
POST /api/user/avatar
Content-Type: multipart/form-data

file: [å›¾ç‰‡æ–‡ä»¶]
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "data": "/uploads/avatars/user123_20241201123456.jpg",
  "message": "å¤´åƒä¸Šä¼ æˆåŠŸ"
}
```

#### è·å–å¤´åƒ
```http
GET /api/user/avatar/{userId}
```

**å“åº”ï¼š** ç›´æ¥è¿”å›å›¾ç‰‡æ–‡ä»¶

## ğŸ”§ é…ç½®è¯´æ˜

### 1. é™æ€æ–‡ä»¶é…ç½®

åœ¨ `Program.cs` ä¸­æ·»åŠ ï¼š
```csharp
// é…ç½®é™æ€æ–‡ä»¶æœåŠ¡
app.UseStaticFiles();
```

### 2. æœåŠ¡æ³¨å†Œ

åœ¨ `ServiceExtensions.cs` ä¸­æ³¨å†Œï¼š
```csharp
services.AddScoped<IAvatarService, AvatarService>();
```

### 3. æ–‡ä»¶å¤§å°é™åˆ¶

é»˜è®¤é…ç½®ï¼š
- æœ€å¤§æ–‡ä»¶å¤§å°ï¼š2MB
- æ”¯æŒæ ¼å¼ï¼šjpgã€jpegã€pngã€gif
- å­˜å‚¨è·¯å¾„ï¼š`wwwroot/uploads/avatars/`

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### 1. å‰ç«¯ä¸Šä¼ ç¤ºä¾‹

```javascript
// ä½¿ç”¨FormDataä¸Šä¼ 
const formData = new FormData();
formData.append('file', fileInput.files[0]);

fetch('/api/user/avatar', {
    method: 'POST',
    headers: {
        'Authorization': `Bearer ${token}`
    },
    body: formData
})
.then(response => response.json())
.then(data => {
    if (data.success) {
        console.log('å¤´åƒä¸Šä¼ æˆåŠŸ:', data.data);
        // æ›´æ–°é¡µé¢æ˜¾ç¤º
        document.getElementById('avatar').src = data.data;
    }
});
```

### 2. æ˜¾ç¤ºå¤´åƒç¤ºä¾‹

```html
<!-- ç›´æ¥ä½¿ç”¨APIåœ°å€ -->
<img src="/api/user/avatar/12345678-1234-1234-1234-123456789012" 
     alt="ç”¨æˆ·å¤´åƒ" 
     onerror="this.src='/images/default-avatar.png'" />

<!-- æˆ–è€…ä½¿ç”¨é™æ€æ–‡ä»¶è·¯å¾„ -->
<img src="/uploads/avatars/user123_20241201123456.jpg" 
     alt="ç”¨æˆ·å¤´åƒ" />
```

## ğŸ›¡ï¸ å®‰å…¨è€ƒè™‘

### 1. æ–‡ä»¶éªŒè¯
- æ–‡ä»¶ç±»å‹éªŒè¯
- æ–‡ä»¶å¤§å°é™åˆ¶
- æ–‡ä»¶åå®‰å…¨æ£€æŸ¥

### 2. è®¿é—®æ§åˆ¶
- ç”¨æˆ·åªèƒ½ä¸Šä¼ è‡ªå·±çš„å¤´åƒ
- å¤´åƒè®¿é—®æƒé™æ§åˆ¶
- é˜²æ­¢æ¶æ„æ–‡ä»¶ä¸Šä¼ 

## ğŸ¯ æ€»ç»“

è¿™ä¸ªå®ç°æ–¹æ¡ˆä¸“ä¸ºæœ¬åœ°å¼€å‘è®¾è®¡ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

1. **ç®€å•æ˜“ç”¨**ï¼šæ— éœ€å¤æ‚é…ç½®ï¼Œå¼€ç®±å³ç”¨
2. **åŠŸèƒ½å®Œæ•´**ï¼šæ”¯æŒä¸Šä¼ ã€è·å–ã€é»˜è®¤å¤´åƒ
3. **å®‰å…¨å¯é **ï¼šåŒ…å«æ–‡ä»¶éªŒè¯å’Œè®¿é—®æ§åˆ¶
4. **æ˜“äºæ‰©å±•**ï¼šå¯ä»¥è½»æ¾å‡çº§åˆ°ç”Ÿäº§ç¯å¢ƒæ–¹æ¡ˆ

**ğŸ’¡ æç¤ºï¼š** åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå»ºè®®ä½¿ç”¨ä¸“ä¸šçš„æ–‡ä»¶å­˜å‚¨æœåŠ¡æˆ–CDNã€‚
