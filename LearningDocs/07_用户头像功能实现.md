# 07_用户头像功能实现 - 本地开发环境解决方案

## 🎯 功能概述

本文档介绍如何在本地开发环境中实现用户头像功能，无需复杂的服务器配置，简单易用。

## 📋 实现方案

### 方案一：本地文件存储（推荐）

**优点：**
- ✅ 简单直接，无需额外服务
- ✅ 适合本地开发和测试
- ✅ 文件直接存储在项目目录中
- ✅ 支持静态文件访问

**缺点：**
- ❌ 不适合生产环境
- ❌ 文件存储分散
- ❌ 扩展性有限

## 🏗️ 技术实现

### 1. 文件结构

```
ECommerce.Identity.API/
├── wwwroot/
│   ├── images/
│   │   └── default-avatar.png    # 默认头像
│   └── uploads/
│       └── avatars/              # 用户头像存储目录
├── Application/
│   ├── Services/
│   │   └── AvatarService.cs      # 头像服务
│   └── Validators/
│       └── AvatarUploadValidator.cs  # 上传验证器
└── Controllers/
    └── UserController.cs         # 用户控制器
```

### 2. 核心服务

#### AvatarService.cs
```csharp
public interface IAvatarService
{
    Task<string> UploadAvatarAsync(IFormFile file, Guid userId);
    Task<byte[]?> GetAvatarAsync(string avatarUrl);
    Task<byte[]?> GetDefaultAvatarAsync();
    Task DeleteAvatarAsync(string avatarUrl);
}
```

**主要功能：**
- 文件上传和存储
- 文件读取和返回
- 旧文件清理
- 默认头像处理

### 3. API接口

#### 上传头像
```http
POST /api/user/avatar
Content-Type: multipart/form-data

file: [图片文件]
```

**响应示例：**
```json
{
  "success": true,
  "data": "/uploads/avatars/user123_20241201123456.jpg",
  "message": "头像上传成功"
}
```

#### 获取头像
```http
GET /api/user/avatar/{userId}
```

**响应：** 直接返回图片文件

## 🔧 配置说明

### 1. 静态文件配置

在 `Program.cs` 中添加：
```csharp
// 配置静态文件服务
app.UseStaticFiles();
```

### 2. 服务注册

在 `ServiceExtensions.cs` 中注册：
```csharp
services.AddScoped<IAvatarService, AvatarService>();
```

### 3. 文件大小限制

默认配置：
- 最大文件大小：2MB
- 支持格式：jpg、jpeg、png、gif
- 存储路径：`wwwroot/uploads/avatars/`

## 📝 使用示例

### 1. 前端上传示例

```javascript
// 使用FormData上传
const formData = new FormData();
formData.append('file', fileInput.files[0]);

fetch('/api/user/avatar', {
    method: 'POST',
    headers: {
        'Authorization': `Bearer ${token}`
    },
    body: formData
})
.then(response => response.json())
.then(data => {
    if (data.success) {
        console.log('头像上传成功:', data.data);
        // 更新页面显示
        document.getElementById('avatar').src = data.data;
    }
});
```

### 2. 显示头像示例

```html
<!-- 直接使用API地址 -->
<img src="/api/user/avatar/12345678-1234-1234-1234-123456789012" 
     alt="用户头像" 
     onerror="this.src='/images/default-avatar.png'" />

<!-- 或者使用静态文件路径 -->
<img src="/uploads/avatars/user123_20241201123456.jpg" 
     alt="用户头像" />
```

## 🛡️ 安全考虑

### 1. 文件验证
- 文件类型验证
- 文件大小限制
- 文件名安全检查

### 2. 访问控制
- 用户只能上传自己的头像
- 头像访问权限控制
- 防止恶意文件上传

## 🎯 总结

这个实现方案专为本地开发设计，具有以下特点：

1. **简单易用**：无需复杂配置，开箱即用
2. **功能完整**：支持上传、获取、默认头像
3. **安全可靠**：包含文件验证和访问控制
4. **易于扩展**：可以轻松升级到生产环境方案

**💡 提示：** 在生产环境中，建议使用专业的文件存储服务或CDN。
