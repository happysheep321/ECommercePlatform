# 核心业务流程建模文档

> 本文档基于 DDD（领域驱动设计）思想，结合聚合建模与微服务架构，梳理电商系统的 8 大核心业务流程，包括用户注册登录、商品上架浏览、购物车、订单、支付、库存、物流、评价与售后。

## 1. 用户注册与登录流程

### 1.1 流程步骤

1. 用户访问注册页面，填写手机号/邮箱、密码等信息。
2. 系统发送验证码至用户提供的联系方式。
3. 用户输入验证码，系统验证其有效性。
4. 系统对密码进行加密处理，创建用户账户。
5. 用户登录时，输入账号和密码。
6. 系统验证用户信息，生成 JWT 或 OAuth2 Token。
7. 用户成功登录，系统返回登录态信息。
8. 系统支持 Token 刷新、黑名单管理、踢出机制等功能。

### 1.2 业务流程图（泳道图）

```mermaid
sequenceDiagram
    participant 用户
    participant 系统

    用户->>系统: 提交注册信息
    系统->>用户: 发送验证码
    用户->>系统: 输入验证码
    系统->>系统: 验证验证码
    alt 验证成功
        系统->>系统: 加密密码，创建账户
        系统->>用户: 注册成功
    else 验证失败
        系统->>用户: 注册失败
    end

    用户->>系统: 输入账号和密码登录
    系统->>系统: 验证用户信息
    alt 验证成功
        系统->>系统: 生成 Token
        系统->>用户: 登录成功，返回 Token
    else 验证失败
        系统->>用户: 登录失败
    end
```



### 1.3 用例图

```mermaid
graph TD
    用户 -->|注册| 系统
    用户 -->|登录| 系统
    系统 -->|发送验证码| 用户
    系统 -->|验证验证码| 系统
    系统 -->|加密密码| 系统
    系统 -->|生成Token| 系统
    系统 -->|返回登录态| 用户

```



## 2. **商品上架与浏览流程**

### 2.1 流程步骤

1. 商家登录后台管理系统。
2. 商家填写商品信息，包括 SPU(标准产品单元)/SKU(最小库存单元)、类目、品牌、价格、库存等。
3. 系统对商品信息进行校验，保存至数据库。
4. 用户访问前台页面，浏览商品列表。
5. 用户可通过分页、类目过滤、关键词搜索等方式查找商品。
6. 用户点击商品，查看商品详情，包括库存、价格、图片、规格等。

### 2.2 业务流程图（泳道图）

```mermaid
sequenceDiagram
    participant 商家
    participant 系统
    participant 用户

    商家->>系统: 提交商品信息
    系统->>系统: 校验并保存商品信息
    系统->>商家: 上架成功

    用户->>系统: 浏览商品列表
    系统->>用户: 返回商品列表
    用户->>系统: 查看商品详情
    系统->>用户: 返回商品详情

```

### 2.3 用例图

```mermaid
graph TD
    商家 -->|上架商品| 系统
    用户 -->|浏览商品| 系统
    用户 -->|搜索商品| 系统
    用户 -->|查看商品详情| 系统

```

## 3. **购物车流程**

### 3.1 流程步骤

1. 用户在商品详情页点击“加入购物车”。
2. 系统将商品 SKU 和数量添加至用户的购物车中。
3. 用户访问购物车页面，查看已添加的商品列表。
4. 用户可修改商品数量或删除购物车项。
5. 系统实时更新购物车信息。

### 3.2 业务流程图（泳道图）

```mermaid
sequenceDiagram
    participant 用户
    participant 系统

    用户->>系统: 加入商品至购物车
    系统->>系统: 添加商品至购物车
    系统->>用户: 返回购物车信息

    用户->>系统: 查看购物车
    系统->>用户: 显示购物车列表

    用户->>系统: 修改/删除购物车项
    系统->>系统: 更新购物车信息
    系统->>用户: 返回更新后的购物车信息
```

### 3.3 用例图

```mermaid
graph TD
    用户 -->|加入购物车| 系统
    用户 -->|查看购物车| 系统
    用户 -->|修改购物车| 系统
    用户 -->|删除购物车项| 系统
```

## 4. **订单创建与管理流程**

### 4.1 流程步骤

1. 用户在购物车页面选择商品，点击“提交订单”。
2. 系统校验商品库存，预占库存。
3. 系统生成订单，状态为“待支付”。
4. 用户支付订单，系统更新订单状态为“已支付”。
5. 商家发货，系统更新订单状态为“待收货”。
6. 用户确认收货，系统更新订单状态为“已完成”。
7. 若用户未支付，系统在设定时间后自动取消订单，释放库存。

### 4.2 业务流程图（泳道图）

```mermaid
sequenceDiagram
    participant 用户
    participant 系统
    participant 商家

    用户->>系统: 提交订单
    系统->>系统: 校验库存，预占库存
    系统->>系统: 生成订单（待支付）
    系统->>用户: 返回订单信息

    用户->>系统: 支付订单
    系统->>系统: 更新订单状态为已支付
    系统->>商家: 通知发货

    商家->>系统: 发货
    系统->>系统: 更新订单状态为待收货
    系统->>用户: 通知发货信息

    用户->>系统: 确认收货
    系统->>系统: 更新订单状态为已完成
```

### 4.3 用例图

```mermaid
graph TD
    用户 -->|提交订单| 系统
    系统 -->|校验库存| 系统
    系统 -->|生成订单| 系统
    用户 -->|支付订单| 系统
    商家 -->|发货| 系统
    用户 -->|确认收货| 系统
```

## 5. **支付流程**

### 5.1 流程步骤

1. 用户在订单页面选择支付方式（支付宝、微信、余额）。
2. 系统跳转至相应的支付平台，用户完成支付。
3. 支付平台异步通知系统支付结果。
4. 系统更新订单支付状态，记录交易信息。
5. 用户可在订单详情中查看支付状态。

### 5.2 业务流程图（泳道图）

```mermaid
sequenceDiagram
    participant 用户
    participant 系统
    participant 支付平台

    用户->>系统: 选择支付方式
    系统->>支付平台: 跳转至支付页面
    用户->>支付平台: 完成支付
    支付平台->>系统: 通知支付结果
    系统->>系统: 更新订单支付状态
    系统->>用户: 返回支付结果
```

### 5.3 用例图

```mermaid
graph TD
    用户 -->|选择支付方式| 系统
    系统 -->|跳转支付平台| 支付平台
    支付平台 -->|通知支付结果| 系统
    系统 -->|更新支付状态| 系统
    用户 -->|查看支付状态| 系统
```

## 6. **库存处理流程**

### 6.1 流程步骤

1. 用户提交订单，系统预扣减库存。
2. 若用户支付成功，系统确认库存扣减。
3. 若用户支付失败或订单取消，系统回滚库存。
4. 系统使用分布式锁机制，确保库存操作的原子性。

### 6.2 业务流程图（泳道图）

```mermaid
sequenceDiagram
    participant 用户
    participant 系统

    用户->>系统: 提交订单
    系统->>系统: 预扣减库存

    alt 支付成功
        系统->>系统: 确认库存扣减
    else 支付失败或订单取消
        系统->>系统: 回滚库存
    end
```

### 6.3 用例图

```mermaid
graph TD
    用户 -->|提交订单| 系统
    系统 -->|预扣减库存| 系统
    系统 -->|确认库存扣减| 系统
    系统 -->|回滚库存| 系统
```

## 7. **发货与物流流程**

### 7.1 流程步骤

1. 商家在后台系统中查看已支付订单，准备发货。
2. 商家填写物流信息，提交发货。
3. 系统更新订单状态为“待收货”，并通知用户。
4. 用户可在订单详情中查看物流信息。
5. 用户收到商品后，确认收货，系统更新订单状态为“已完成”。

### 7.2 业务流程图（泳道图）

```mermaid
sequenceDiagram
    participant 商家
    participant 系统
    participant 用户

    商家->>系统: 提交发货信息
    系统->>系统: 更新订单状态为待收货
    系统->>用户: 通知发货信息

    用户->>系统: 查看物流信息
    用户->>系统: 确认收货
    系统->>系统: 更新订单状态为已完成
```

### 7.3 用例图

```mermaid
graph TD
    商家 -->|提交发货信息| 系统
    系统 -->|更新订单状态| 系统
    用户 -->|查看物流信息| 系统
    用户 -->|确认收货| 系统
```

## 8. **评价与售后流程**

### 8.1 流程步骤

1. 用户在订单完成后，可对商品进行评价，填写星级和文字内容。
2. 用户在订单详情中点击“申请售后”，进入售后申请流程。
3. 用户选择售后类型（退款、退货退款、换货）、填写理由和上传凭证图片。
4. 系统记录申请，并通知商家。
5. 商家审核售后请求，选择“同意”或“拒绝”并填写原因。
6. 若同意，用户按流程退货或系统直接退款。
7. 售后完成后，系统记录售后结果并更新订单状态为“已售后”。

### 8.2 业务流程图（泳道图）

```mermaid
sequenceDiagram
    participant 用户
    participant 系统
    participant 商家

    用户->>系统: 发表评价
    系统->>系统: 存储评价信息

    用户->>系统: 提交售后申请（退款/退货/换货）
    系统->>系统: 记录申请
    系统->>商家: 通知审核

    商家->>系统: 审核同意/拒绝
    alt 同意
        系统->>用户: 提供退货地址或自动退款
        用户->>系统: 上传退货凭证
        系统->>系统: 更新售后状态
    else 拒绝
        系统->>用户: 通知拒绝原因
    end
```

### 8.3 用例图

```mermaid
graph TD
    用户 -->|提交评价| 系统
    用户 -->|申请售后| 系统
    系统 -->|通知商家| 商家
    商家 -->|审核售后| 系统
    系统 -->|更新售后状态| 系统
```